# savedsearches.conf

#  _____       _   _ _   _                 _ _
# | ____|_ __ | |_(_) |_(_) ___  ___    __| (_)___  ___ _____   _____ _ __ _   _
# |  _| | '_ \| __| | __| |/ _ \/ __|  / _` | / __|/ __/ _ \ \ / / _ \ '__| | | |
# | |___| | | | |_| | |_| |  __/\__ \ | (_| | \__ \ (_| (_) \ V /  __/ |  | |_| |
# |_____|_| |_|\__|_|\__|_|\___||___/  \__,_|_|___/\___\___/ \_/ \___|_|   \__, |
#                                                                          |___/

#  _     _
# | |   (_)_ __  _   ___  __
# | |   | | '_ \| | | \ \/ /
# | |___| | | | | |_| |>  <
# |_____|_|_| |_|\__,_/_/\_\
#

[DA-ITSI-TELEGRAF-OS-Inventory_Search_linux]
search = | mstats latest(_value) as value where `telegraf_index` metric_name="system.n_cpus" OR metric_name="mem.total" OR metric_name="swap.total" by metric_name, host\
| eval nb_cpus=case(metric_name="system.n_cpus", value), swap_total=case(metric_name="swap.total", value/1024/1024), mem_total=case(metric_name="mem.total", value/1024/1024)\
| stats first(nb_cpus) as nb_cpus, first(mem_total) as mem_total, first(swap_total) as swap_total by host\
| foreach *_total [ eval <<FIELD>> = round('<<FIELD>>', 0) ]\
| eval itsi_role="telegraf_host", family="Linux"\
| join type=inner host [ | mcatalog values(metric_name) as linux_kernel where index="telegraf" metric_name="kernel.*" by host ] | fields - linux_kernel\
| fields host, itsi_role, family, nb_cpus, mem_total, swap_total
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

# __        ___           _
# \ \      / (_)_ __   __| | _____      _____
#  \ \ /\ / /| | '_ \ / _` |/ _ \ \ /\ / / __|
#   \ V  V / | | | | | (_| | (_) \ V  V /\__ \
#    \_/\_/  |_|_| |_|\__,_|\___/ \_/\_/ |___/
#

[DA-ITSI-TELEGRAF-OS-Inventory_Search_windows]
search = | mstats latest(_value) as value where `telegraf_index` metric_name=win_cpu.Percent_Idle_Time instance!=_Total by host, instance\
| stats dc(instance) as nb_cpus by host\
| join type=outer host [ | mstats latest(_value) as mem_total where `telegraf_index` metric_name="mem.total" by host\
| eval mem_total=round(mem_total/1073741824, 2) ]\
| fillnull value="NA" mem_total\
| eval itsi_role="telegraf_host", family="Windows"\
| join type=inner host [ | mcatalog values(metric_name) as win_metrics where `telegraf_index` metric_name="win_*" by host ] | fields - win_metrics\
| fields host, itsi_role, family, nb_cpus, mem_total
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#  _   _           _                             _
# | | | | ___  ___| |_   ___  ___  __ _ _ __ ___| |__
# | |_| |/ _ \/ __| __| / __|/ _ \/ _` | '__/ __| '_ \
# |  _  | (_) \__ \ |_  \__ \  __/ (_| | | | (__| | | |
# |_| |_|\___/|___/\__| |___/\___|\__,_|_|  \___|_| |_|
#

#  _     _
# | |   (_)_ __  _   ___  __
# | |   | | '_ \| | | \ \/ /
# | |___| | | | | |_| |>  <
# |_____|_|_| |_|\__,_/_/\_\
#

[DA-ITSI-TELEGRAF-OS-Host_Search_linux]
search = | mstats latest(_value) as value where `telegraf_index` metric_name="system.n_cpus" OR metric_name="mem.total" OR metric_name="swap.total" host=$host$ by metric_name\
| eval nb_cpus=case(metric_name="system.n_cpus", value), swap_total=case(metric_name="swap.total", value/1024/1024), mem_total=case(metric_name="mem.total", value/1024/1024)\
| stats first(nb_cpus) as nb_cpus, first(mem_total) as mem_total, first(swap_total) as swap_total\
| foreach *_total [ eval <<FIELD>> = round('<<FIELD>>', 0) ]\
| `telegraf-get-closest-disk-unit(mem_total)`\
| eval mem_total = mem_total . " " . unit_to_use, swap_total = swap_total . " " . unit_to_use, family="Linux"\
| fields family, nb_cpus, mem_total, swap_total
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

# __        ___           _
# \ \      / (_)_ __   __| | _____      _____
#  \ \ /\ / /| | '_ \ / _` |/ _ \ \ /\ / / __|
#   \ V  V / | | | | | (_| | (_) \ V  V /\__ \
#    \_/\_/  |_|_| |_|\__,_|\___/ \_/\_/ |___/
#

[DA-ITSI-TELEGRAF-OS-Host_Search_windows]
search = | mstats latest(_value) as value where `telegraf_index` metric_name=win_cpu.Percent_Idle_Time instance!=_Total host=$host$ by instance\
| stats dc(instance) as nb_cpus\
| appendcols [ | mstats latest(_value) as mem_total where `telegraf_index` metric_name="mem.total" host=$host$\
| eval mem_total=round(mem_total/1024/1024, 0)\
| `telegraf-get-closest-disk-unit(mem_total)` | eval mem_total = mem_total . " " . unit_to_use ]\
| fillnull value="NA" mem_total\
| eval itsi_role="telegraf_host", family="Windows"\
| fields family, nb_cpus, mem_total
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

#  __  __ _       _            _                _
# |  \/  (_)_ __ (_)       ___| |__   __ _ _ __| |_ ___
# | |\/| | | '_ \| |_____ / __| '_ \ / _` | '__| __/ __|
# | |  | | | | | | |_____| (__| | | | (_| | |  | |_\__ \
# |_|  |_|_|_| |_|_|      \___|_| |_|\__,_|_|   \__|___/
#
#                 _        _
#  _ __ ___   ___| |_ _ __(_) ___ ___
# | '_ ` _ \ / _ \ __| '__| |/ __/ __|
# | | | | | |  __/ |_| |  | | (__\__ \
# |_| |_| |_|\___|\__|_|  |_|\___|___/
#

#  _     _
# | |   (_)_ __  _   ___  __
# | |   | | '_ \| | | \ \/ /
# | |___| | | | | |_| |>  <
# |_____|_|_| |_|\__,_/_/\_\
#

[DA-ITSI-TELEGRAF-OS-Context_Chart_CPU_Search_linux]
search = | mstats avg(_value) as value where `telegraf_index` metric_name=cpu.usage_iowait OR metric_name=cpu.usage_steel OR metric_name=cpu.usage_system OR metric_name=cpu.usage_user host=$host$ by metric_name span=1s\
| eval {metric_name}=value\
| stats first(cpu.*) as "cpu.*" by _time\
| eval cpu.usage=('cpu.usage_iowait'+'cpu.usage_system'+'cpu.usage_user')\
| stats max(cpu.usage) AS max_usage, avg(cpu.usage) AS avg_usage\
| foreach "*" \
    [ eval <<FIELD>> = round('<<FIELD>>', 2) ]\
| eval pct_used=avg_usage, summary="Avg %:" . avg_usage . " Max %: " . max_usage\
| fields pct_used, summary
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-TELEGRAF-OS-Context_Chart_Memory_Search_linux]
search = | mstats avg(_value) as avg_usage max(_value) as max_usage where `telegraf_index` metric_name=mem.used_percent host=$host$\
| foreach "*"\
    [ eval <<FIELD>> = round('<<FIELD>>', 2) ]\
| eval pct_used=avg_usage, summary="Max %:" . max_usage . " Avg %: " . avg_usage\
| fields pct_used, summary
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-TELEGRAF-OS-Context_Chart_Disk_Usage_Search_linux]
search = | mstats latest(_value) as value where `telegraf_index` metric_name=disk.used OR metric_name=disk.total `devices_exclusions` host=$host$ by metric_name, device\
| eval {metric_name}=value\
| stats first(disk.used) as disk.used, first(disk.total) as disk.total by device\
| stats sum(disk.used) as disk.used, sum(disk.total) as disk.total\
| eval pct_used=round('disk.used'/'disk.total'*100, 2)\
| eval disk.used=round('disk.used'/1024/1024/1024, 2) . " GB", disk.total=round('disk.total'/1024/1024/1024, 2) . " GB"\
| eval used_space="Total used " . 'disk.used'\
| fields + pct_used, used_space
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

# __        ___           _
# \ \      / (_)_ __   __| | _____      _____
#  \ \ /\ / /| | '_ \ / _` |/ _ \ \ /\ / / __|
#   \ V  V / | | | | | (_| | (_) \ V  V /\__ \
#    \_/\_/  |_|_| |_|\__,_|\___/ \_/\_/ |___/
#

[DA-ITSI-TELEGRAF-OS-Context_Chart_CPU_Search_windows]
search = | mstats avg(_value) as avg_Percent_Idle, min(_value) as max_Percent_Idle where `telegraf_index` metric_name="win_cpu.Percent_Idle_Time" instance=_Total\
| eval avg_usage=round((100-avg_Percent_Idle), 2), max_usage=round((100-max_Percent_Idle), 2) | fields avg_usage, max_usage\
| eval pct_used=avg_usage, summary="Avg %:" . avg_usage . " Max %: " . max_usage\
| fields pct_used, summary
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-TELEGRAF-OS-Context_Chart_Memory_Search_windows]
search = | mstats avg(_value) as avg_usage max(_value) as max_usage where `telegraf_index` metric_name=mem.used_percent host=$host$\
| foreach "*"\
    [ eval <<FIELD>> = round('<<FIELD>>', 2) ]\
| eval pct_used=avg_usage, summary="Max %:" . max_usage . " Avg %: " . avg_usage\
| fields pct_used, summary
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search

[DA-ITSI-TELEGRAF-OS-Context_Chart_Disk_Usage_Search_windows]
search = | mstats latest(_value) as value where `telegraf_index` metric_name=win_disk.Percent_Free_Space OR metric_name=win_disk.Free_Megabytes host=$host$ by metric_name, instance\
| eval {metric_name}=value\
| stats first(win_disk.*) as "*" by instance\
| eval Percent_Free_Space=round(Percent_Free_Space, 2), disk.total=(Free_Megabytes/Percent_Free_Space)*100, disk.used='disk.total'-Free_Megabytes\
| stats sum(disk.used) as disk.used, sum(disk.total) as disk.total\
| eval pct_used=round('disk.used'/'disk.total'*100, 2)\
| eval disk.used=round('disk.used'/1024, 2) . " GB", disk.total=round('disk.total'/1024, 2) . " GB"\
| eval used_space="Total used " . 'disk.used'\
| fields + pct_used, used_space
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search
